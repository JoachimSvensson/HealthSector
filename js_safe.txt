document.addEventListener("DOMContentLoaded", () => {
    const tidsperiode = document.getElementById("tidsperiode");
    const datoerDiv = document.getElementById("datoer");
    const plotBtn = document.getElementById("plot-btn");
    const plotImg = document.getElementById("plot");
    const tableDiv = document.getElementById("table-container");
    const HOTtableDiv = document.getElementById("hot-container");
    const addRowButton = document.getElementById('addRowButton');
    const sheetSelector = document.getElementById("sheetSelector");


    function clearDisplay() {
        plotImg.style.display = "none";
        plotImg.src = ""; 
        tableDiv.innerHTML = ""; 
        // HOTtableDiv.innerHTML = ""; // Nullstill tabellinnhold
    }

    sheetSelector.addEventListener("change", async () => {
        const option = {sheet_name : sheetSelector.value};
        const response = await fetch('/api/get_table', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(option)
        });
        const data = await response.json();
        
        clearDisplay();

        if (data.table) { 
            const tableData = data.table.data; 
            const tableHeaders = data.table.headers; 

            const hot = new Handsontable(HOTtableDiv, {
                data: tableData,
                columns: new Array(tableHeaders.length).fill({}),
                colHeaders: tableHeaders,
                rowHeaders: true,
                width: '100%',
                height: 400,
                stretchH: 'all',
                licenseKey: 'non-commercial-and-evaluation', // Kreves for gratisversjonen av Handsontable
                contextMenu: true,
                editor: 'text',
                allowInsertRow: true,
            });

            // addRowButton.addEventListener('click', function () {
            //     hot.alter('insert_row', hot.countRows());
            //     hot.render();
            // });
        }
    });


    tidsperiode.addEventListener("change", () => {
        if (tidsperiode.value === "custom") {
            datoerDiv.style.display = "block";
        } else {
            datoerDiv.style.display = "none";
        }
    });

 
    plotBtn.addEventListener("click", async () => {
        const params = {
            tidsperiode: tidsperiode.value,
            aggregering: document.getElementById("aggregering").value,
            visualiseringskolonne: document.getElementById("visualiseringskolonne").value,
            skift: document.getElementById("skift").value,
            start_dato: document.getElementById("start-dato").value,
            slutt_dato: document.getElementById("slutt-dato").value
        };

        try {
            const response = await fetch('/api/get_plot_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            const data = await response.json();

            clearDisplay(); 

            if (data.plot) {
                plotImg.src = `data:image/png;base64,${data.plot}`;
                plotImg.style.display = 'block';
            }

            if (data.table) {
                tableDiv.innerHTML = data.table;                
            }
        } catch (error) {
            console.error("Feil ved henting av data:", error);
        }
    });
});
